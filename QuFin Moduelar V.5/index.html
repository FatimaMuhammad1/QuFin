<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QuFin: AI-powered trading intelligence platform leveraging quantum-inspired algorithms and alternative data for unmatched market insights.">
    <meta name="keywords" content="QuFin, AI trading, financial analytics, quantum algorithms, alternative data, market intelligence, trading signals">
    <meta property="og:title" content="QuFin - AI-Powered Trading Intelligence">
    <meta property="og:description" content="Harness quantum algorithms and machine learning for unparalleled market insights. Start your journey with QuFin today.">
    <meta property="og:image" content="assets/images/qufin-og-image.jpg">
    <meta property="og:image" content="logo.png">
    <meta property="og:url" content="https://www.qufin.ai">
    <meta name="robots" content="index, follow">
    <title>QuFin - AI-Powered Trading Intelligence for the Quantum Age</title>
    
    <!-- Loading Indicator -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles/fontawesome-free-7.0.1/css/all.min.css">
    
    <style>
        :root {
            --quantum-blue: #0ea5e9;
            --ai-purple: #8b5cf6;
            --data-green: #10b981;
            --risk-orange: #f59e0b;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-text: #f1f5f9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }
        
        body.dark {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }
        
        body.dark header {
            background-color: var(--dark-card);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }

        .logo-img {
            height: 2.50rem;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--quantum-blue), var(--ai-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--quantum-blue), var(--ai-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav-desktop {
            display: flex;
            gap: 8px;
        }
        
        @media (max-width: 1024px) {
            .nav-desktop {
                display: none;
            }
        }
        
        .nav-item {
            position: relative;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            color: inherit;
            transition: background-color 0.2s;
        }
        
        .nav-link:hover {
            background-color: rgba(14, 165, 233, 0.1);
        }
        
        body.dark .nav-link:hover {
            background-color: rgba(14, 165, 233, 0.2);
        }
        
        .nav-link i {
            margin-right: 8px;
        }
        
        .mega-menu {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            min-width: 800px;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 12px 12px;
            padding: 24px;
            display: none;
            z-index: 1000;
        }
        
        body.dark .mega-menu {
            background: var(--dark-card);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        
        .nav-item:hover .mega-menu {
            display: block;
        }
        
        .nav-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
        }
        
        .nav-category h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--quantum-blue);
        }
        
        .nav-category ul {
            list-style: none;
        }
        
        .nav-category li {
            margin-bottom: 8px;
        }
        
        .nav-category a {
            color: #64748b;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        body.dark .nav-category a {
            color: #94a3b8;
        }
        
        .nav-category a:hover {
            color: var(--quantum-blue);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .theme-toggle {
            padding: 8px;
            border-radius: 50%;
            background: none;
            border: none;
            cursor: pointer;
            color: #64748b;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #0f172a;
        }
        
        body.dark .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
        }
        
        .btn-primary {
            padding: 10px 20px;
            background: var(--quantum-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background: #0284c7;
        }
        
        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
        }
        
        @media (max-width: 1024px) {
            .mobile-toggle {
                display: block;
            }
        }
        
        .mobile-menu {
            position: fixed;
            top: 72px;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 999;
            display: none;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        
        body.dark .mobile-menu {
            background: var(--dark-card);
        }
        
        .mobile-menu.open {
            display: block;
        }
        
        .mobile-nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .mobile-nav-item {
            padding: 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        .mobile-nav-item:hover {
            background-color: rgba(14, 165, 233, 0.1);
        }
        
        body.dark .mobile-nav-item:hover {
            background-color: rgba(14, 165, 233, 0.2);
        }
        
        .mobile-nav-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
        }
        
        .mobile-nav-link i {
            margin-right: 12px;
            width: 20px;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #05374e 0%, #0ea5e9 50%, #8b5cf6 100%);
            color: white;
            padding: 80px 0;
            position: relative;
            overflow: hidden;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(14, 165, 233, 0.2) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.2) 0%, transparent 50%);
            z-index: 1;
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .hero h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 24px;
            line-height: 1.2;
        }
        
        .hero p {
            font-size: 20px;
            margin-bottom: 40px;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .hero-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 60px;
        }
        
        .btn-white {
            padding: 12px 32px;
            background: white;
            color: var(--quantum-blue);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-white:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
        }
        
        .btn-outline-white {
            padding: 12px 32px;
            background: transparent;
            color: white;
            border: 2px solid white;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-outline-white:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .hero-metrics {
            display: flex;
            justify-content: center;
            gap: 48px;
        }
        
        .metric {
            text-align: center;
        }
        
        .metric .number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .metric .label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 36px;
            }
            
            .hero p {
                font-size: 18px;
            }
            
            .hero-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .hero-metrics {
                flex-direction: column;
                gap: 24px;
            }
        }
        
        /* AI Products Section */
        .section {
            padding: 80px 0;
        }
        
        .section-light {
            background: white;
        }
        
        body.dark .section-light {
            background: var(--dark-card);
        }
        
        .section-dark {
            background: #f8fafc;
        }
        
        body.dark .section-dark {
            background: var(--dark-bg);
        }
        
        .section-header {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 60px;
        }
        
        .section-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .section-subtitle {
            font-size: 18px;
            color: #64748b;
        }
        
        body.dark .section-subtitle {
            color: #94a3b8;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
        }
        
        .product-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 4px solid var(--quantum-blue);
        }
        
        body.dark .product-card {
            background: #1e293b;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body.dark .product-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .product-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: rgba(14, 165, 233, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--quantum-blue);
            font-size: 20px;
        }
        
        .product-status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--data-green);
        }
        
        .product-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .product-description {
            color: #64748b;
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        body.dark .product-description {
            color: #94a3b8;
        }
        
        .product-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .metric-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .accuracy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--data-green);
        }
        
        .speed {
            background: rgba(14, 165, 233, 0.1);
            color: var(--quantum-blue);
        }
        
        /* Dashboard Section */
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }
        
        @media (max-width: 968px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        body.dark .dashboard-card {
            background: var(--dark-card);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .time-selector {
            display: flex;
            gap: 8px;
        }
        
        .time-btn {
            padding: 6px 12px;
            background: #f1f5f9;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        body.dark .time-btn {
            background: #334155;
            color: white;
        }
        
        .time-btn.active {
            background: var(--quantum-blue);
            color: white;
        }
        
        .market-metrics {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .market-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        body.dark .market-metric {
            border-bottom-color: #334155;
        }
        
        .market-metric:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .metric-info {
            display: flex;
            flex-direction: column;
        }
        
        .metric-name {
            font-weight: 500;
        }
        
        .metric-symbol {
            font-size: 14px;
            color: #64748b;
        }
        
        body.dark .metric-symbol {
            color: #94a3b8;
        }
        
        .metric-value {
            font-weight: 500;
        }
        
        .metric-change {
            font-size: 14px;
        }
        
        .positive {
            color: var(--data-green);
        }
        
        .negative {
            color: #ef4444;
        }
        
        .signals-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            background: #f8fafc;
        }
        
        body.dark .signal-item {
            background: #334155;
        }
        
        .signal-item.buy {
            border-left: 4px solid var(--data-green);
        }
        
        .signal-item.sell {
            border-left: 4px solid #ef4444;
        }
        
        .signal-item.hold {
            border-left: 4px solid var(--risk-orange);
        }
        
        .signal-asset {
            font-weight: 500;
        }
        
        .signal-timeframe {
            font-size: 12px;
            color: #64748b;
        }
        
        body.dark .signal-timeframe {
            color: #94a3b8;
        }
        
        .signal-action {
            font-weight: 600;
        }
        
        .signal-buy {
            color: var(--data-green);
        }
        
        .signal-sell {
            color: #ef4444;
        }
        
        .signal-hold {
            color: var(--risk-orange);
        }
        
        .signal-confidence {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        
        body.dark .signal-confidence {
            color: #94a3b8;
        }
        
        .confidence-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
            width: 80px;
        }
        
        body.dark .confidence-bar {
            background: #475569;
        }
        
        .confidence-fill {
            height: 100%;
            border-radius: 2px;
        }
        
        .buy .confidence-fill {
            background: var(--data-green);
        }
        
        .sell .confidence-fill {
            background: #ef4444;
        }
        
        .hold .confidence-fill {
            background: var(--risk-orange);
        }
        
        /* World Map Section */
        .world-map-container {
            position: relative;
            width: 100%;
            height: 600px;
            background: #f8fafc;
            border-radius: 12px;
            overflow: hidden;
        }
        
        body.dark .world-map-container {
            background: #1e293b;
        }
        
        .map-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }
        
        body.dark .map-placeholder {
            color: #94a3b8;
        }
        
        .map-placeholder i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }

        .country-tooltip {
            position: absolute;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.85);
            color: #ffffff;
            border-radius: 8px;
            pointer-events: none;
            font-size: 14px;
            z-index: 10000;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            max-width: 260px;
            line-height: 1.4;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        
        .map-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        body.dark .map-btn {
            background: #334155;
            border-color: #475569;
            color: white;
        }
        
        .map-btn:hover {
            background: #f1f5f9;
        }
        
        body.dark .map-btn:hover {
            background: #475569;
        }
        
        .map-btn.active {
            background: var(--quantum-blue);
            color: white;
            border-color: var(--quantum-blue);
        }
        
        /* Footer */
        footer {
            background: #1e293b;
            color: #94a3b8;
            padding: 60px 0 30px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 968px) {
            .footer-content {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        .footer-logo {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .footer-logo-text {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }
        
        .footer-description {
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .social-links {
            display: flex;
            gap: 12px;
        }
        
        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .social-link:hover {
            background: var(--quantum-blue);
        }
        
        .footer-column h3 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 12px;
        }
        
        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid #334155;
            font-size: 14px;
        }
        
        /* Auth Modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .auth-modal.open {
            display: flex;
        }
        
        .auth-container {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            padding: 30px;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        body.dark .auth-container {
            background: var(--dark-card);
        }
        
        .auth-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #64748b;
        }
        
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        
        body.dark .auth-tabs {
            border-bottom-color: #334155;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .auth-tab.active {
            color: var(--quantum-blue);
            border-bottom: 2px solid var(--quantum-blue);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        body.dark .form-group input {
            background: #334155;
            border-color: #475569;
            color: white;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--quantum-blue);
        }
        
        .auth-submit {
            width: 100%;
            padding: 12px;
            background: var(--quantum-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .auth-submit:hover {
            background: #0284c7;
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 16px;
        }
        
        .auth-footer a {
            color: var(--quantum-blue);
            text-decoration: none;
            font-size: 14px;
        }
        
        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* OTP Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .modal h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1e293b;
        }

        .modal p {
            color: #64748b;
            margin-bottom: 24px;
        }

        #otp-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #otp-form label {
            display: none;
        }

        #otp-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s;
        }

        #otp-form input:focus {
            border-color: #0ea5e9;
            outline: none;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .btn-verify {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        .btn-verify:hover {
            background: #0284c7;
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* OTP Modal Styles */
        #otp-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        #otp-modal.open {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-content h2 {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 0.5rem;
        }

        .modal-content p {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .modal-content .form-group {
            margin-bottom: 1.5rem;
        }

        .modal-content input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-verify {
            background: #0ea5e9;
            color: white;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }

        .btn-verify:hover {
            background: #0284c7;
        }

        #error-message {
            color: #ef4444;
            margin-top: 1rem;
            font-size: 0.875rem;
            text-align: center;
        }
    </style>
    <!-- D3 and TopoJSON for world map -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="logo-text">QuFin.ai</div>
                </div>
                
                <nav class="nav-desktop">
                    <div class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            AI Analytics
                        </a>
                        <div class="mega-menu">
                            <div class="nav-categories">
                                <div class="nav-category">
                                    <h4>Market Intelligence</h4>
                                    <ul>
                                        <li><a href="pages/aiscoregrid.html">AI Score Grid</a></li>
                                        <li><a href="#">Quantum Signals</a></li>
                                        <li><a href="#">Predictive Models</a></li>
                                        <li><a href="#">Sentiment Analysis</a></li>
                                    </ul>
                                </div>
                                <div class="nav-category">
                                    <h4>Data Analytics</h4>
                                    <ul>
                                        <li><a href="#">Alternative Data</a></li>
                                        <li><a href="#">Economic Indicators</a></li>
                                        <li><a href="#">Sector Analysis</a></li>
                                        <li><a href="#">Risk Assessment</a></li>
                                    </ul>
                                </div>
                                <div class="nav-category">
                                    <h4>Visualization</h4>
                                    <ul>
                                        <li><a href="#">Global Heatmaps</a></li>
                                        <li><a href="#">Portfolio Analytics</a></li>
                                        <li><a href="#">Performance Metrics</a></li>
                                        <li><a href="#">Custom Dashboards</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item">
                        <a href="pages/aistrategies.html" class="nav-link">
                            <i class="fas fa-robot"></i>
                            Trading Intelligence
                        </a>
                        <div class="mega-menu">
                            <div class="nav-categories">
                                <div class="nav-category">
                                    <h4>Strategy Tools</h4>
                                    <ul>
                                        <li><a href="#">Strategy Builder</a></li>
                                        <li><a href="#">Backtesting Engine</a></li>
                                        <li><a href="#">Portfolio Optimization</a></li>
                                        <li><a href="#">Risk Analytics</a></li>
                                    </ul>
                                </div>
                                <div class="nav-category">
                                    <h4>Execution</h4>
                                    <ul>
                                        <li><a href="#">Algorithmic Trading</a></li>
                                        <li><a href="#">Signal Generation</a></li>
                                        <li><a href="#">Order Management</a></li>
                                        <li><a href="#">Performance Tracking</a></li>
                                    </ul>
                                </div>
                                <div class="nav-category">
                                    <h4>Analysis</h4>
                                    <ul>
                                        <li><a href="#">Technical Analysis</a></li>
                                        <li><a href="#">Fundamental Analysis</a></li>
                                        <li><a href="#">Quantitative Models</a></li>
                                        <li><a href="#">Market Regimes</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item">
                        <a href="pages/product.html" class="nav-link">
                            <i class="fas fa-cube"></i>
                            AI Products
                        </a>
                        <div class="mega-menu">
                            <div class="nav-categories">
                                <div class="nav-category">
                                    <h4>Core Products</h4>
                                    <ul>
                                        <li><a href="#">CurrenQ™</a></li>
                                        <li><a href="#">EnergAI™</a></li>
                                        <li><a href="#">MetalAI™</a></li>
                                        <li><a href="#">FuturAI™</a></li>
                                        <li><a href="#">CryptAI™</a></li>
                                    </ul>
                                </div>
                                <div class="nav-category">
                                    <h4>Advanced Tools</h4>
                                    <ul>
                                        <li><a href="#">NeuroLock™</a></li>
                                        <li><a href="#">Strategy DNA™</a></li>
                                        <li><a href="#">Signal Sieve™</a></li>
                                        <li><a href="#">Capital Guard™</a></li>
                                        <li><a href="#">Glass Book™</a></li>
                                    </ul>
                                </div>
                                <div class="nav-category">
                                    <h4>Data Products</h4>
                                    <ul>
                                        <li><a href="#">Commoditas™</a></li>
                                        <li><a href="#">Equivestia™</a></li>
                                        <li><a href="#">Indicem™</a></li>
                                        <li><a href="#">TradeFit Quotient™</a></li>
                                        <li><a href="#">Corelation Matrix™</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item">
                        <a href="pages/globaldata.html" class="nav-link">
                            <i class="fas fa-globe"></i>
                            Global Data
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="pages/resources.html" class="nav-link">
                            <i class="fas fa-book"></i>
                            Resources
                        </a>
                    </div>
                </nav>
                
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn-primary" id="loginBtn">
                        <i class="fas fa-user"></i>
                        Login
                    </button>
                    <button class="mobile-toggle" id="mobileToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="container">
                <nav class="mobile-nav">
                    <div class="mobile-nav-item">
                        <a href="pages/aiscoregrid.html" class="mobile-nav-link">
                            <i class="fas fa-chart-line"></i>
                            AI Analytics
                        </a>
                    </div>
                    <div class="mobile-nav-item">
                        <a href="pages/aistrategies.html" class="mobile-nav-link">
                            <i class="fas fa-robot"></i>
                            Trading Intelligence
                        </a>
                    </div>
                    <div class="mobile-nav-item">
                        <a href="pages/product.html" class="mobile-nav-link">
                            <i class="fas fa-cube"></i>
                            AI Products
                        </a>
                    </div>
                    <div class="mobile-nav-item">
                        <a href="pages/globaldata.html" class="mobile-nav-link">
                            <i class="fas fa-globe"></i>
                            Global Data
                        </a>
                    </div>
                    <div class="mobile-nav-item">
                        <a href="pages/resources.html" class="mobile-nav-link">
                            <i class="fas fa-book"></i>
                            Resources
                        </a>
                    </div>
                    <div class="mobile-nav-item">
                        <button class="btn-primary" style="width: 100%; justify-content: center;" id="mobileLoginBtn">
                            <i class="fas fa-user"></i>
                            Login
                        </button>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <h1>AI-Powered Trading Intelligence for the <span style="background: linear-gradient(135deg, #fff, #e0f2fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Quantum Age</span></h1>
                <p>Harness alternative data, quantum algorithms, and machine learning for unparalleled market insights</p>
                <div class="hero-actions">
                    <button class="btn-white" id="trialBtn">Start Free Trial</button>
                    <button class="btn-outline-white">View Live Demo</button>
                </div>
                <div class="hero-metrics">
                    <div class="metric">
                        <div class="number">2.4M+</div>
                        <div class="label">Data Points Analyzed</div>
                    </div>
                    <div class="metric">
                        <div class="number">98.7%</div>
                        <div class="label">Prediction Accuracy</div>
                    </div>
                    <div class="metric">
                        <div class="number">24/7</div>
                        <div class="label">Real-time Monitoring</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Products Section -->
    <section class="section section-light">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Our AI Product Suite</h2>
                <p class="section-subtitle">Powered by quantum-inspired algorithms and cutting-edge machine learning techniques</p>
            </div>
            
            <div class="products-grid">
                <div class="product-card" onclick="alert('Learn more about Quantum Forecast Engine')">
                    <div class="product-header">
                        <div class="product-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <span class="product-status status-active">Active</span>
                    </div>
                    <h3 class="product-title">Quantum Forecast Engine</h3>
                    <p class="product-description">Advanced time-series prediction using quantum-inspired algorithms</p>
                    <div class="product-metrics">
                        <span class="metric-badge accuracy">
                            <i class="fas fa-bullseye"></i>
                            96.3% Accuracy
                        </span>
                        <span class="metric-badge speed">
                            <i class="fas fa-bolt"></i>
                            Real-time
                        </span>
                    </div>
                </div>
                
                <div class="product-card" onclick="alert('Learn more about NeuroLock Risk Manager')">
                    <div class="product-header">
                        <div class="product-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span class="product-status status-active">Active</span>
                    </div>
                    <h3 class="product-title">NeuroLock Risk Manager</h3>
                    <p class="product-description">AI-powered risk assessment and portfolio protection</p>
                    <div class="product-metrics">
                        <span class="metric-badge accuracy">
                            <i class="fas fa-bullseye"></i>
                            94.7% Accuracy
                        </span>
                        <span class="metric-badge speed">
                            <i class="fas fa-bolt"></i>
                            &lt;100ms
                        </span>
                    </div>
                </div>
                
                <div class="product-card" onclick="alert('Learn more about Signal Sieve')">
                    <div class="product-header">
                        <div class="product-icon">
                            <i class="fas fa-filter"></i>
                        </div>
                        <span class="product-status status-active">Active</span>
                    </div>
                    <h3 class="product-title">Signal Sieve</h3>
                    <p class="product-description">Filters market noise to identify high-probability trading signals</p>
                    <div class="product-metrics">
                        <span class="metric-badge accuracy">
                            <i class="fas fa-bullseye"></i>
                            92.1% Accuracy
                        </span>
                        <span class="metric-badge speed">
                            <i class="fas fa-bolt"></i>
                            Real-time
                        </span>
                    </div>
                </div>
                
                <div class="product-card" onclick="alert('Learn more about Strategy DNA')">
                    <div class="product-header">
                        <div class="product-icon">
                            <i class="fas fa-dna"></i>
                        </div>
                        <span class="product-status status-active">Active</span>
                    </div>
                    <h3 class="product-title">Strategy DNA</h3>
                    <p class="product-description">Genetic algorithm optimization for trading strategy development</p>
                    <div class="product-metrics">
                        <span class="metric-badge accuracy">
                            <i class="fas fa-bullseye"></i>
                            95.8% Accuracy
                        </span>
                        <span class="metric-badge speed">
                            <i class="fas fa-bolt"></i>
                            Batch
                        </span>
                    </div>
                </div>
                
                <div class="product-card" onclick="alert('Learn more about Capital Guard')">
                    <div class="product-header">
                        <div class="product-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <span class="product-status status-active">Active</span>
                    </div>
                    <h3 class="product-title">Capital Guard</h3>
                    <p class="product-description">Dynamic position sizing and drawdown control</p>
                    <div class="product-metrics">
                        <span class="metric-badge accuracy">
                            <i class="fas fa-bullseye"></i>
                            98.2% Accuracy
                        </span>
                        <span class="metric-badge speed">
                            <i class="fas fa-bolt"></i>
                            Real-time
                        </span>
                    </div>
                </div>
                
                <div class="product-card" onclick="alert('Learn more about Glass Book Analytics')">
                    <div class="product-header">
                        <div class="product-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <span class="product-status status-active">Active</span>
                    </div>
                    <h3 class="product-title">Glass Book Analytics</h3>
                    <p class="product-description">Market microstructure and order flow analysis</p>
                    <div class="product-metrics">
                        <span class="metric-badge accuracy">
                            <i class="fas fa-bullseye"></i>
                            91.5% Accuracy
                        </span>
                        <span class="metric-badge speed">
                            <i class="fas fa-bolt"></i>
                            &lt;50ms
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Global Intelligence Section -->
    <section class="section section-dark">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Global Economic Intelligence</h2>
                <p class="section-subtitle">Monitor country economic performance with our interactive heatmap and access powerful AI tools for investment decisions</p>
            </div>
            
            <div class="world-map-container">
                <div id="dataStatus" class="data-status" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 8px 12px; border-radius: 4px; font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="color: #22c55e;">✓</span>
                    <span>Using Latest Economic Scores</span>
                </div>
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <script>
                    // Immediately update the data status
                    const dataStatus = document.getElementById('dataStatus');
                    if (dataStatus) {
                        dataStatus.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #22c55e;">✓</span>
                                <span>Using Latest Economic Scores</span>
                            </div>
                        `;
                    }
                </script>
                <div class="map-controls">
                    <button class="map-btn active" data-metric="economic">
                        <i class="fas fa-star"></i>
                        Economic Score
                    </button>
                    <button class="map-btn" data-metric="gdp">
                        <i class="fas fa-chart-line"></i>
                        GDP Growth
                    </button>
                    <button class="map-btn" data-metric="inflation">
                        <i class="fas fa-money-bill-wave"></i>
                        Inflation
                    </button>
                    <button class="map-btn" data-metric="employment">
                        <i class="fas fa-briefcase"></i>
                        Employment
                    </button>
                </div>
                
                    <div id="worldMap" style="width:100%; height:100%;"></div>
                
                <script>
                    // Store different metrics data
                    window.countryMetrics = {
                        economic: window.countryScores || {},
                        gdp: {},
                        inflation: {},
                        employment: {}
                    };

                    // Initialize with sample data (replace with actual API data)
                    window.countryMetrics.gdp = {
                        "USA": 2.3, "CHN": 5.2, "DEU": 1.8, "JPN": 1.7, "GBR": 1.5,
                        "FRA": 1.6, "IND": 6.3, "BRA": 2.9, "CAN": 1.8, "ITA": 0.7
                    };
                    
                    window.countryMetrics.inflation = {
                        "USA": 3.7, "CHN": 2.8, "DEU": 4.5, "JPN": 3.3, "GBR": 6.7,
                        "FRA": 4.9, "IND": 5.6, "BRA": 4.8, "CAN": 3.8, "ITA": 5.3
                    };
                    
                    window.countryMetrics.employment = {
                        "USA": 3.8, "CHN": 5.2, "DEU": 3.0, "JPN": 2.6, "GBR": 4.2,
                        "FRA": 7.2, "IND": 8.1, "BRA": 7.8, "CAN": 5.5, "ITA": 7.4
                    };

                    let currentMetric = 'economic';

                    // Function to update map colors
                    function updateMapColors() {
                        d3.selectAll('path')
                            .transition()
                            .duration(750)
                            .attr('fill', function(d) {
                                const isoCode = d.properties.iso_a3;
                                const rawValue = window.countryMetrics[currentMetric][isoCode];
                                
                                if (rawValue === undefined || rawValue === null) return '#ccc';
                                
                                let colorValue;
                                if (currentMetric === 'economic') {
                                    colorValue = rawValue;
                                } else if (currentMetric === 'gdp') {
                                    colorValue = (rawValue + 5) * 10;
                                } else if (currentMetric === 'inflation') {
                                    colorValue = Math.max(0, 100 - rawValue * 5);
                                } else if (currentMetric === 'employment') {
                                    colorValue = Math.max(0, 100 - rawValue * 5);
                                }
                                
                                return colorScale(Math.min(100, Math.max(0, colorValue)));
                            });
                    }

                    // Add click handlers to metric buttons
                    document.querySelectorAll('.map-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            // Update active button
                            document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
                            this.classList.add('active');
                            
                            // Update current metric
                            currentMetric = this.dataset.metric;
                            
                            // Update map colors based on new metric
                            updateMapColors();
                        });
                    });

                    function getMetricData(isoCode) {
                        const data = window.countryMetrics[currentMetric][isoCode];
                        let suffix = '';
                        if (currentMetric === 'economic') suffix = '';
                        else if (currentMetric === 'gdp') suffix = '%';
                        else if (currentMetric === 'inflation') suffix = '%';
                        else if (currentMetric === 'employment') suffix = '%';
                        return data !== undefined ? data + suffix : 'N/A';
                    }

                    function getMetricLabel() {
                        switch(currentMetric) {
                            case 'economic': return 'Economic Score';
                            case 'gdp': return 'GDP Growth';
                            case 'inflation': return 'Inflation Rate';
                            case 'employment': return 'Unemployment Rate';
                            default: return '';
                        }
                    }
                </script>
            </div>
        </div>
    </section>

    <!-- Dashboard Section -->
    <section class="section section-light">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Real-Time Trading Intelligence</h2>
                <p class="section-subtitle">Monitor your investments and market trends with our clean, customizable dashboard</p>
            </div>
            
            <div class="dashboard">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">Market Overview</h3>
                        <div class="time-selector">
                            <button class="time-btn active">1D</button>
                            <button class="time-btn">1W</button>
                            <button class="time-btn">1M</button>
                            <button class="time-btn">1Y</button>
                        </div>
                    </div>
                    
                    <div class="market-metrics">
                        <div class="market-metric">
                            <div class="metric-info">
                                <span class="metric-name">S&P 500</span>
                                <span class="metric-symbol">US Equities</span>
                            </div>
                            <div class="metric-values">
                                <div class="metric-value">4,567.89</div>
                                <div class="metric-change positive">+1.24%</div>
                            </div>
                        </div>
                        
                        <div class="market-metric">
                            <div class="metric-info">
                                <span class="metric-name">NASDAQ</span>
                                <span class="metric-symbol">US Tech</span>
                            </div>
                            <div class="metric-values">
                                <div class="metric-value">14,253.27</div>
                                <div class="metric-change positive">+2.03%</div>
                            </div>
                        </div>
                        
                        <div class="market-metric">
                            <div class="metric-info">
                                <span class="metric-name">BTC/USD</span>
                                <span class="metric-symbol">Cryptocurrency</span>
                            </div>
                            <div class="metric-values">
                                <div class="metric-value">$63,452.34</div>
                                <div class="metric-change positive">+3.72%</div>
                            </div>
                        </div>
                        
                        <div class="market-metric">
                            <div class="metric-info">
                                <span class="metric-name">Gold</span>
                                <span class="metric-symbol">Commodities</span>
                            </div>
                            <div class="metric-values">
                                <div class="metric-value">$1,987.50</div>
                                <div class="metric-change negative">-0.45%</div>
                            </div>
                        </div>
                        
                        <div class="market-metric">
                            <div class="metric-info">
                                <span class="metric-name">Crude Oil</span>
                                <span class="metric-symbol">Energy</span>
                            </div>
                            <div class="metric-values">
                                <div class="metric-value">$78.45</div>
                                <div class="metric-change negative">-0.87%</div>
                            </div>
                        </div>
                        
                        <div class="market-metric">
                            <div class="metric-info">
                                <span class="metric-name">EUR/USD</span>
                                <span class="metric-symbol">Forex</span>
                            </div>
                            <div class="metric-values">
                                <div class="metric-value">1.0845</div>
                                <div class="metric-change positive">+0.12%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">AI Trading Signals</h3>
                    </div>
                    
                    <div class="signals-container">
                        <div class="signal-item buy">
                            <div>
                                <div class="signal-asset">AAPL</div>
                                <div class="signal-timeframe">1D</div>
                            </div>
                            <div>
                                <div class="signal-action signal-buy">BUY</div>
                                <div class="signal-confidence">87% confidence</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 87%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="signal-item sell">
                            <div>
                                <div class="signal-asset">TSLA</div>
                                <div class="signal-timeframe">3D</div>
                            </div>
                            <div>
                                <div class="signal-action signal-sell">SELL</div>
                                <div class="signal-confidence">72% confidence</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 72%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="signal-item buy">
                            <div>
                                <div class="signal-asset">BTC/USD</div>
                                <div class="signal-timeframe">1W</div>
                            </div>
                            <div>
                                <div class="signal-action signal-buy">BUY</div>
                                <div class="signal-confidence">91% confidence</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 91%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="signal-item hold">
                            <div>
                                <div class="signal-asset">EUR/USD</div>
                                <div class="signal-timeframe">4H</div>
                            </div>
                            <div>
                                <div class="signal-action signal-hold">HOLD</div>
                                <div class="signal-confidence">65% confidence</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 65%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="signal-item buy">
                            <div>
                                <div class="signal-asset">Gold</div>
                                <div class="signal-timeframe">2D</div>
                            </div>
                            <div>
                                <div class="signal-action signal-buy">BUY</div>
                                <div class="signal-confidence">78% confidence</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 78%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div>
                    <div class="footer-logo">
                        <div class="footer-logo-text">QuFin.ai</div>
                    </div>
                    <p class="footer-description">AI-powered trading intelligence platform providing cutting-edge analytics and alternative data signals for modern investors.</p>
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-github"></i></a>
                    </div>
                </div>
                
                <div>
                    <h3>Products</h3>
                    <ul class="footer-links">
                        <li><a href="pages/aiscoregrid.html">AI Score Grid</a></li>
                        <li><a href="#">Market Data</a></li>
                        <li><a href="#">Trading Strategies</a></li>
                        <li><a href="#">Backtesting</a></li>
                        <li><a href="#">Risk Management</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3>Resources</h3>
                    <ul class="footer-links">
                        <li><a href="#">Learning Academy</a></li>
                        <li><a href="#">Market Reports</a></li>
                        <li><a href="#">Blog</a></li>
                        <li><a href="#">Webinars</a></li>
                        <li><a href="#">API Documentation</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3>Company</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3>Support</h3>
                    <ul class="footer-links">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Contact Support</a></li>
                        <li><a href="#">Service Status</a></li>
                        <li><a href="#">Feature Requests</a></li>
                        <li><a href="#">System Requirements</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>© 2025 QuFin.ai. All rights reserved. | <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
            </div>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <button class="auth-close" id="authClose">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="signup">Sign Up</div>
            </div>
            
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                
                <button type="submit" class="auth-submit">Login</button>
                
                <div class="auth-footer">
                    <a href="#">Forgot your password?</a>
                </div>
            </form>
            
            <form class="auth-form" id="signupForm">
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Create a password">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password">
                </div>
                
                <button type="submit" class="auth-submit">Sign Up</button>
            </form>
        </div>
    </div>

    <!-- OTP Modal -->
    <div id="otp-modal">
        <div class="modal-content">
            <h2>OTP Verification</h2>
            <p>OTP sent to your email. Please enter it below:</p>
            <form id="otp-form">
                <div class="form-group">
                    <input type="text" id="otp" name="otp" required 
                        placeholder="Enter 6-digit code" 
                        maxlength="6" 
                        pattern="[0-9]*" 
                        inputmode="numeric">
                </div>
                <button type="submit" class="btn-verify">Verify</button>
            </form>
            <p id="error-message" class="error-message"></p>
        </div>
    </div>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        // Check for saved theme or prefer-color-scheme
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
            document.body.classList.add('dark');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        }
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            
            if (document.body.classList.contains('dark')) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });
        
        // Mobile Menu Toggle
        const mobileToggle = document.getElementById('mobileToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        
        mobileToggle.addEventListener('click', () => {
            mobileMenu.classList.toggle('open');
            
            // Change icon
            const icon = mobileToggle.querySelector('i');
            if (mobileMenu.classList.contains('open')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });
        
        // Auth Modal
        const authModal = document.getElementById('authModal');
        const loginBtn = document.getElementById('loginBtn');
        const mobileLoginBtn = document.getElementById('mobileLoginBtn');
        const trialBtn = document.getElementById('trialBtn');
        const authClose = document.getElementById('authClose');
        const authTabs = document.querySelectorAll('.auth-tab');
        const authForms = document.querySelectorAll('.auth-form');
        
        // Open modal
        [loginBtn, mobileLoginBtn, trialBtn].forEach(btn => {
            btn.addEventListener('click', () => {
                authModal.classList.add('open');
            });
        });
        
        // Close modal
        authClose.addEventListener('click', () => {
            authModal.classList.remove('open');
        });
        
        // Switch tabs
        authTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');
                
                // Update active tab
                authTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding form
                authForms.forEach(form => {
                    form.classList.remove('active');
                    if (form.id === `${targetTab}Form`) {
                        form.classList.add('active');
                    }
                });
            });
        });
        
        // Form submission - perform real login against backend
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch('http://127.0.0.1:8000/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                let data = null;
                const ct = res.headers.get('content-type') || '';
                if (ct.includes('application/json')) data = await res.json();
                else {
                    const text = await res.text();
                    try { data = JSON.parse(text); } catch (err) { data = { message: text }; }
                }

                console.log('Login response', res.status, data);
                if (res.ok && data.token) {
                    // store token via central helper so UI updates consistently
                    if (window.authHandler && typeof window.authHandler.setAuthToken === 'function') {
                        window.authHandler.setAuthToken(data.token);
                    } else {
                        localStorage.setItem('qufin_token', data.token);
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('isLoggedIn', 'true');
                        // mark session so auth-handler treats this as an explicit login even if it wasn't loaded yet
                        localStorage.setItem('qufin_session', '1');
                        try { window.authHandler.updateAuthButtonText(true); } catch (err) { /* noop */ }
                    }

                    // close modal
                    authModal.classList.remove('open');
                } else {
                    // Provide more diagnostic detail to help debug failures
                    const details = data && (data.detail || data.message) ? (data.detail || data.message) : JSON.stringify(data) || '(no body)';
                    console.warn('Login failed', { status: res.status, body: data });
                    alert(`Login failed (status ${res.status}): ${details}`);
                }
            } catch (err) {
                console.error('Login error', err);
                alert('An error occurred while logging in: ' + (err && err.message ? err.message : String(err)));
            }
        });
        
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect form data
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords
            if (password !== confirmPassword) {
                alert('Passwords do not match.');
                return;
            }

            try {
                console.log('Submitting signup', { name, email });
                // POST to the backend signup endpoint (FastAPI)
                const response = await fetch('http://127.0.0.1:8000/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password, username: name }),
                });

                // safe parse response
                let result = null;
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) result = await response.json();
                else {
                    const txt = await response.text();
                    try { result = JSON.parse(txt); } catch (err) { result = { message: txt }; }
                }

                console.log('Signup response', response.status, result);

                if (response.ok) {
                    // store email for OTP verification
                    localStorage.setItem('authEmail', email);
                    alert(result.message || 'Signup successful — OTP sent.');
                    authModal.classList.remove('open');
                    // show OTP modal if present
                    const otpModal = document.getElementById('otp-modal');
                    if (otpModal) showOtpModal();
                } else {
                    alert(`Signup failed: ${result.detail || result.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert('An error occurred during signup. Please try again later.');
                console.error(error);
            }
        });
        
        // OTP Modal functionality
        const otpModal = document.getElementById('otp-modal');
        const otpForm = document.getElementById('otp-form');
        const otpInput = document.getElementById('otp');
        const errorMessage = document.getElementById('error-message');
        
        function showOtpModal() {
            otpModal.classList.add('open');
            otpInput.focus();
            startOtpTimer();
        }
        
        function hideOtpModal() {
            otpModal.classList.remove('open');
            otpInput.value = '';
            errorMessage.classList.remove('visible');
        }
        
        // Close modal on outside click
        otpModal.addEventListener('click', (e) => {
            if (e.target === otpModal) {
                hideOtpModal();
            }
        });
        
        // Handle OTP input
        otpInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 6);
            errorMessage.classList.remove('visible');
        });
        
        // OTP form submission
        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const otp = otpInput.value;
            
            if (otp.length !== 6) {
                errorMessage.textContent = 'Please enter a valid 6-digit code';
                errorMessage.classList.add('visible');
                return;
            }
            
            try {
                // Replace with your actual API call
                const response = await fetch('/api/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        otp,
                        email: localStorage.getItem('authEmail')
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideOtpModal();
                    // Redirect or update UI as needed
                    window.location.href = '/dashboard';
                } else {
                    throw new Error(data.message || 'Invalid code');
                }
            } catch (error) {
                errorMessage.textContent = error.message || 'Invalid verification code';
                errorMessage.classList.add('visible');
            }
        });
        
        let otpTimer;
        function startOtpTimer() {
            clearTimeout(otpTimer);
            otpTimer = setTimeout(() => {
                errorMessage.textContent = 'OTP expired. Please request a new code.';
                errorMessage.classList.add('visible');
            }, 300000); // 5 minutes
        }
        
        // Simulate sending OTP and opening modal (replace with actual logic)
        document.getElementById('mobileLoginBtn').addEventListener('click', () => {
            // Close auth modal if open
            if (authModal.classList.contains('open')) {
                authModal.classList.remove('open');
            }
            
            // Simulate OTP sent
            setTimeout(() => {
                otpModal.style.display = 'block';
            }, 500);
        });
        
        // Close OTP modal on outside click
        window.addEventListener('click', (e) => {
            if (e.target === otpModal) {
                otpModal.style.display = 'none';
            }
        });
        
        // OTP form submission
        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const otpValue = document.getElementById('otp').value;
            const email = localStorage.getItem('authEmail');

            if (!email) {
                errorMessage.textContent = 'Email missing from signup flow. Please sign up again.';
                return;
            }

            try {
                console.log('Submitting OTP verify', { email, otp: otpValue });
                const response = await fetch('http://127.0.0.1:8000/auth/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, otp: otpValue }),
                });

                let result = null;
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) result = await response.json();
                else {
                    const txt = await response.text();
                    try { result = JSON.parse(txt); } catch (err) { result = { message: txt }; }
                }

                console.log('OTP verify response', response.status, result);

                    if (response.ok) {
                        // save token if backend returned one
                        if (result && result.token) {
                            if (window.authHandler && typeof window.authHandler.setAuthToken === 'function') {
                                window.authHandler.setAuthToken(result.token);
                            } else {
                                localStorage.setItem('qufin_token', result.token);
                                localStorage.setItem('token', result.token);
                                localStorage.setItem('isLoggedIn', 'true');
                                try { window.authHandler.updateAuthButtonText(true); } catch (err) { /* noop */ }
                            }
                        }
                    alert('OTP verified successfully! You are now logged in.');
                    otpModal.style.display = 'none';
                    // optionally clear stored email
                    localStorage.removeItem('authEmail');
                    // Update header UI to reflect logged-in state and stay on page
                    try { window.authHandler.updateAuthButtonText(true); } catch (err) { /* noop */ }
                } else {
                    errorMessage.textContent = `OTP verification failed: ${result.detail || result.message || 'Unknown error'}`;
                }
            } catch (error) {
                errorMessage.textContent = 'An error occurred during OTP verification. Please try again later.';
                console.error('OTP verify error', error);
            }
        });
        
        /* ---------- World Map (D3 + TopoJSON) - full behavior from previous code ---------- */

        /*
         * Load a multi-indicator country economic score client-side and normalize to 0-100.
         * Indicators used (World Bank):
         *  - GDP per capita: NY.GDP.PCAP.CD (higher = better)
         *  - Unemployment rate: SL.UEM.TOTL.ZS (higher = worse)
         *  - Inflation (CPI, %): FP.CPI.TOTL.ZG (higher = worse)
         *
         * Composite weights: GDP_per_capita=0.5, unemployment=0.3, inflation=0.2
         * Missing indicator values are ignored in the composite and weighting is rescaled.
         */
        // Try the backend endpoint first; if it returns scores, use them. Otherwise fall back
        // to the client-side composite loader below.
        // Initialize with your provided mapping while loading
        window.countryScores = {"TMN":39,"IDA":41,"RUS":44,"ESP":42,"FRA":46,"BLR":46,"THA":48,"OED":48,"MHL":12,"GNQ":41,"HND":42,"BOL":43,"CPV":38,"TGO":43,"ISL":54,"YEM":51,"PNG":49,"SST":45,"EAR":42,"PST":49,"OSS":45,"AFW":48,"CUB":37,"AZE":43,"BTN":43,"BGR":46,"CIV":44,"MNG":45,"TJK":26,"NLD":54,"SSD":77,"IDB":47,"HRV":45,"XKX":29,"GMB":39,"KAZ":43,"NOR":56,"LBR":49,"ERI":84,"ZAF":23,"MYS":47,"CYP":47,"EST":48,"EAP":43,"BMU":42,"SVK":48,"AGO":35,"COG":33,"MUS":44,"HTI":31,"BEN":44,"MIC":42,"GAB":34,"AFE":39,"LAO":49,"NPL":36,"CHN":43,"TSA":42,"COM":32,"ECS":46,"CHI":51,"BDI":41,"IBT":42,"FRO":27,"LIE":81,"SUR":41,"MNA":39,"MLI":43,"TCA":19,"MWI":45,"BWA":30,"TSS":41,"KWT":50,"SLB":44,"BFA":41,"TUV":10,"LMY":42,"CHL":41,"CAF":40,"NGA":47,"HKG":62,"NZL":49,"ISR":50,"GRC":41,"NRU":14,"VEN":85,"IRN":36,"LCN":42,"MNP":9,"SEN":44,"SLE":40,"TLA":42,"SWZ":9,"GTM":43,"BRN":49,"SMR":52,"MEX":45,"EGY":38,"ECA":41,"PSS":44,"EMU":48,"AUT":51,"CZE":50,"MCO":100,"MDA":45,"PLW":29,"PRE":42,"ABW":23,"MAC":57,"GIN":43,"ZWE":32,"MNE":38,"VIR":39,"CUW":15,"ROU":44,"GRL":21,"SAS":42,"FJI":45,"MMR":38,"ARM":39,"RWA":35,"BLZ":42,"BHS":45,"GUM":37,"NIC":43,"TUN":36,"MDV":48,"LVA":46,"ETH":40,"PER":42,"SOM":20,"MDG":42,"DOM":42,"GBR":49,"QAT":59,"MRT":39,"FSM":26,"TUR":37,"SRB":42,"SSF":41,"SGP":66,"GRD":34,"UZB":42,"OMN":49,"CAN":49,"DNK":54,"PYF":29,"SXM":20,"LKA":40,"TKM":33,"ARE":56,"KIR":24,"IRQ":35,"BEL":52,"IDX":41,"ALB":40,"DZA":37,"MAR":40,"ATG":34,"BRA":40,"SVN":50,"KGZ":43,"WLD":43,"AND":23,"SAU":47,"IND":42,"TON":43,"GUY":43,"CRI":43,"IDN":43,"LCA":44,"LTE":43,"SLV":44,"SWE":49,"SSA":41,"BIH":40,"HUN":46,"EUU":48,"IRL":62,"IMN":34,"STP":42,"PRK":92,"CSS":47,"CEB":47,"BGD":41,"VUT":40,"BHR":53,"JOR":34,"ITA":45,"COL":38,"UGA":42,"NCL":37,"PRY":43,"PRI":40,"MLT":61,"SYR":22,"HPC":42,"COD":34,"GNB":42,"MAF":8,"VNM":49,"PAN":44,"AUS":51,"NAM":34,"MOZ":44,"PRT":46,"KNA":35,"MKD":39,"CMR":42,"DJI":35,"CYM":44,"USA":52,"LBY":37,"ZMB":41,"TZA":43,"GEO":40,"MEA":41,"CHE":58,"WSM":42,"JPN":47,"TLS":44,"ASM":11,"ARB":41,"DEU":51,"NER":45,"SYC":36,"ECU":44,"TCD":44,"NAC":52,"KOR":49,"ARG":33,"LUX":72,"PSE":27,"DMA":33,"LAC":42,"TTO":50,"FIN":48,"AFG":35,"PAK":38,"IBD":42,"PHL":44,"LTU":47,"KHM":48,"UKR":38,"POL":48,"SDN":29,"LBN":23,"LDC":41,"JAM":48,"VCT":37,"GHA":41,"URY":42,"BRB":48,"KEN":40,"LSO":34};
        
        // Debug check to ensure scores are loaded
        console.log('Initial country scores loaded:', Object.keys(window.countryScores).length, 'countries');
        console.log('Sample scores:', {
            USA: window.countryScores.USA,
            CHN: window.countryScores.CHN,
            GBR: window.countryScores.GBR,
            IRN: window.countryScores.IRN
        });

        (async function tryBackendThenComposite() {
            // Skip loading from backend since we have the scores
            window._countryScoresLoaded = 'static';
            return;

            // Backend failed or returned no data — run composite loader defined below.
        })();

        (async function loadCompositeCountryScores() {
            // If backend already populated scores, skip composite.
            if (window._countryScoresLoaded === 'backend') {
                return;
            }
            try {
                const indicators = {
                    gdp_per_capita: 'NY.GDP.PCAP.CD',
                    unemployment: 'SL.UEM.TOTL.ZS',
                    inflation: 'FP.CPI.TOTL.ZG'
                };
                const years = '2019:2022';

                const fetchIndicator = async (code) => {
                    const url = `https://api.worldbank.org/v2/country/all/indicator/${code}?format=json&date=${years}&per_page=20000`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`World Bank ${code} request failed: ${res.status}`);
                    const j = await res.json();
                    return Array.isArray(j) && j[1] ? j[1] : [];
                };

                const keys = Object.keys(indicators);
                const responses = await Promise.all(keys.map(k => fetchIndicator(indicators[k])));

                // latest values per iso3 for each indicator
                const latest = {};
                for (let i = 0; i < keys.length; i++) {
                    const key = keys[i];
                    const rows = responses[i];
                    latest[key] = {};
                    for (const row of rows) {
                        const iso3 = row.countryiso3code;
                        const year = parseInt(row.date, 10);
                        const val = row.value;
                        if (!iso3 || val === null) continue;
                        if (!latest[key][iso3] || year > latest[key][iso3].year) {
                            latest[key][iso3] = { value: Number(val), year };
                        }
                    }
                }

                // collect ISO3 set
                const isoSet = new Set();
                keys.forEach(k => Object.keys(latest[k] || {}).forEach(i => isoSet.add(i)));
                const isoList = Array.from(isoSet);

                // helper: build numeric arrays per indicator for normalization
                const valuesByKey = {};
                keys.forEach(k => {
                    valuesByKey[k] = Object.values(latest[k] || {}).map(o => o.value).filter(v => typeof v === 'number' && !isNaN(v));
                });

                // compute min/max per indicator
                const ranges = {};
                keys.forEach(k => {
                    const arr = valuesByKey[k];
                    if (arr.length > 0) {
                        ranges[k] =
 {
                            min: Math.min(...arr),
                            max: Math.max(...arr),
                        };
                    } else {
                        ranges[k] = null;
                    }
                });

                // weights
                const weights = { gdp_per_capita: 0.5, unemployment: 0.3, inflation: 0.2 };

                const scores = {};
                for (const iso of isoList) {
                    let total = 0;
                    let weightSum = 0;
                    for (const k of keys) {
                        const obj = latest[k] && latest[k][iso];
                        if (!obj || ranges[k] === null) continue;
                        const v = obj.value;
                        const { min, max } = ranges[k];
                        let norm = (max > min) ? ((v - min) / (max - min)) * 100 : 50;
                        // invert where higher is worse
                        if (k === 'unemployment' || k === 'inflation') {
                            norm = 100 - norm;
                        }
                        const w = weights[k] || 0;
                        total += norm * w;
                        weightSum += w;
                    }
                    if (weightSum > 0) {
                        scores[iso] = Math.round(total / weightSum);
                    }
                }

                if (Object.keys(scores).length > 0) {
                    // Convert all scores to numbers and validate them
                    const validatedScores = {};
                    for (const [key, value] of Object.entries(scores)) {
                        const numericValue = parseFloat(value);
                        if (!isNaN(numericValue)) {
                            validatedScores[key] = numericValue;
                        }
                    }
                    
                    window.countryScores = validatedScores;
                    console.log('Validated scores:', {
                        total: Object.keys(validatedScores).length,
                        sample: Object.entries(validatedScores).slice(0, 5),
                        hasRUS: validatedScores.hasOwnProperty('RUS'),
                        RUSScore: validatedScores['RUS']
                    });
                }
            } catch (err) {
                console.warn('Failed to load composite countryScores:', err);
            }
        })().catch(e => console.warn(e));

                (async function initWorldMap(){
                    // Use the already initialized countryScores from above

                    // Try to load scores from API
                    // Hide loading overlay immediately
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                    
                    // Update data status
                    const dataStatus = document.getElementById('dataStatus');
                    if (dataStatus) {
                        dataStatus.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #22c55e;">✓</span>
                                <span>Using Latest Economic Scores</span>
                            </div>
                        `;
                    }

                    const mapContainer = document.getElementById('worldMap');
                    if (!mapContainer) return;
                    mapContainer.innerHTML = '';

                    const width = mapContainer.clientWidth || 960;
                    const height = mapContainer.clientHeight || 600;

                    const svg = d3.select(mapContainer)
                        .append('svg')
                        .attr('width', '100%')
                        .attr('height', '100%')
                        .attr('viewBox', `0 0 ${width} ${height}`)
                        .style('display', 'block');

                    // Create tooltip
                    const tooltip = d3.select('body').append('div')
                        .attr('class', 'country-tooltip')
                        .style('opacity', 0)
                        .style('position', 'absolute')
                        .style('background', '#1a1a1a')
                        .style('color', '#fff')
                        .style('padding', '10px')
                        .style('border-radius', '5px')
                        .style('pointer-events', 'none')
                        .style('z-index', 1000);

                    // Slight vertical offset so the map sits lower in the container (matches design)
                    const verticalOffset = Math.round(height * 0.08);
                    const projection = d3.geoNaturalEarth1()
                        .scale(width / 6.5)
                        .translate([width / 2, height / 2 + verticalOffset]);

                    const path = d3.geoPath().projection(projection);

                    // Color scale for scores
                    const colorScale = d3.scaleLinear()
                        .domain([0, 50, 100])
                        .range(['#fef3c7', '#ff8a00', '#ef4444']);

                    // Load and render the world map
                    d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(function(data) {
                        const features = topojson.feature(data, data.objects.countries).features;

                        svg.selectAll('path')
                            .data(features)
                            .enter()
                            .append('path')
                            .attr('d', path)
                            .attr('fill', d => {
                                const isoCode = d.properties.iso_a3;
                                const score = window.countryScores[isoCode];
                                
                                if (score === undefined || score === null) return '#ccc';
                                return colorScale(Math.min(100, Math.max(0, score)));
                            })
                            .attr('stroke', '#fff')
                            .attr('stroke-width', '0.5')
                            .on('mouseover', function(event, d) {
                                const countryCode = d.properties.iso_a3;
                                const countryName = d.properties.name;
                                
                                // Try to get score in multiple ways
                                let score = null;
                                if (window.countryScores) {
                                    // First try with ISO3 code
                                    score = window.countryScores[countryCode];
                                    
                                    // If not found, try with ISO2 code
                                    if (score === undefined || score === null) {
                                        const alternateCode = d.properties.iso_a2;
                                        if (alternateCode) {
                                            score = window.countryScores[alternateCode];
                                        }
                                    }
                                    
                                    // If still not found, try with country name
                                    if (score === undefined || score === null) {
                                        score = window.countryScores[countryName];
                                    }
                                }
                                const scoreColor = (score !== undefined && score !== null) ? colorScale(score) : '#94a3b8';
                                
                                tooltip.transition()
                                    .duration(200)
                                    .style('opacity', .9);
                                    
                                tooltip.html(`
                                    <div style="background: rgba(30, 41, 59, 0.95); padding: 12px; border-radius: 8px; min-width: 200px;">
                                        <h3 style="color: #fff; font-size: 16px; margin: 0 0 8px 0;">${d.properties.name}</h3>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="color: #94a3b8;">Economic Score:</span>
                                            <span style="font-weight: 600; color: ${colorScale(score)}; font-size: 18px;">
                                                ${typeof score === 'number' ? score.toFixed(1) : 'N/A'}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                            <span style="color: #64748b;">Status:</span>
                                            <span style="color: ${colorScale(score)}; font-weight: 500;">
                                                ${typeof score === 'number' ? 
                                                    score >= 70 ? 'Excellent' :
                                                    score >= 50 ? 'Good' :
                                                    score >= 30 ? 'Fair' : 'Poor'
                                                : 'Unknown'}
                                            </span>
                                        </div>
                                        <div style="height: 4px; background: rgba(255,255,255,0.1); margin-top: 8px; border-radius: 2px; overflow: hidden;">
                                            <div style="height: 100%; width: ${typeof score === 'number' ? score : 0}%; background: ${colorScale(score)}; transition: width 0.3s ease;"></div>
                                        </div>
                                        <div style="color: #64748b; font-size: 12px; margin-top: 8px;">
                                            ISO Code: ${countryCode || 'Unknown'}
                                        </div>
                                    </div>
                                `)
                                    .style('left', (event.pageX + 10) + 'px')
                                    .style('top', (event.pageY - 28) + 'px');
                            })
                            .on('mouseout', function() {
                                tooltip.transition()
                                    .duration(500)
                                    .style('opacity', 0);
                            });
                    });

            const init = async () => {
                // Make sure we're using the correct scores
                if (!window.countryScores) {
                    console.error('No country scores available');
                    return;
                }
                console.log('Initializing map with scores:', Object.keys(window.countryScores).length, 'countries');
                const mapContainer = document.getElementById('worldMap');
                if (!mapContainer) return;

                // remove any previous content
                mapContainer.innerHTML = '';

                const width = mapContainer.clientWidth || 960;
                const height = mapContainer.clientHeight || 600;

                const svg = d3.select(mapContainer)
                    .append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .style('display', 'block');

                // Tooltip styled to match site theme
                const tooltipDiv = d3.select('body')
                    .append('div')
                    .attr('class', 'country-tooltip')
                    .style('opacity', 0)
                    .style('display', 'none')
                    .style('position', 'absolute')
                    .style('pointer-events', 'none')
                    .style('z-index', 10000)
                    .style('background', 'rgba(0,0,0,0.95)')
                    .style('padding', '12px')
                    .style('border-radius', '8px')
                    .style('box-shadow', '0 4px 12px rgba(0,0,0,0.3)')
                    .style('font-family', 'Arial, sans-serif')
                    .style('max-width', '300px');

                // Slight vertical offset so the map sits lower in the container (matches design)
                const verticalOffset = Math.round(height * 0.08); // adjust this fraction to fine-tune
                const projection = d3.geoNaturalEarth1()
                    .scale(width / 6.5)
                    .translate([width / 2, height / 2 + verticalOffset]);

                const path = d3.geoPath().projection(projection);

                const colorScale = d3.scaleLinear()
                    .domain([0, 25, 50, 75, 100])
                    .range(['#ef4444', '#ff8a00', '#fef3c7', '#84cc16', '#22c55e'])
                    .clamp(true)  // Ensure values are clamped to the range
                    .interpolate(d3.interpolateRgb);

                // Use the global countryScores or fallback to defaults
                // This should already be populated from site-init.js or from index.html initialization
                if (!window.countryScores) {
                    console.warn('No country scores loaded yet, using fallback');
                    window.countryScores = {
                        "USA": 72, "CAN": 71, "GBR": 68, "DEU": 74, "FRA": 70,
                        "CHN": 55, "JPN": 71, "AUS": 70, "BRA": 52, "IND": 48
                    };
                }
                const globalScores = window.countryScores;
                console.log('Map initialized with', Object.keys(globalScores).length, 'countries');

                // small helper to compute deterministic placeholder values
                const deterministicPlaceholder = (code) => {
                    if (!code) return 50;
                    let h = 0; for (let i = 0; i < code.length; i++) h = (h << 5) - h + code.charCodeAt(i);
                    h = Math.abs(h);
                    return (h % 100) + 1;
                };

                d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(function(worldData){
                    const countries = topojson.feature(worldData, worldData.objects.countries).features;

                    svg.selectAll('.country')
                        .data(countries)
                        .enter().append('path')
                        .attr('class', 'country')
                        .attr('d', path)
                        .attr('fill', d => {
                            // Prefer ISO in the feature properties (d.properties). Fall back to geometry properties if needed.
                            const geom = (worldData && worldData.objects && worldData.objects.countries && worldData.objects.countries.geometries)
                                ? worldData.objects.countries.geometries.find(g => g.id === d.id)
                                : null;
                            const props = (d && d.properties) ? d.properties : (geom && geom.properties) ? geom.properties : {};
                            const isoCode = props.iso_a3 || props.ADM0_A3 || props.ISO_A3 || props.iso_a2 || null;
                            const score = isoCode && (window.countryScores && window.countryScores[isoCode] !== undefined) ? window.countryScores[isoCode] : undefined;
                            return (typeof score === 'number') ? colorScale(Math.max(0, Math.min(100, Math.round(score)))) : '#ccc';
                        })
                        .style('stroke', '#fff')
                        .style('stroke-width', 0.5)
                        .style('opacity', 0.8)
                        .style('transition', 'fill 220ms ease, transform 180ms ease')
                        .on('mouseover', async function(event, d) {
                            // Get properties from feature first, fallback to geometry properties
                            const geom = (worldData && worldData.objects && worldData.objects.countries && worldData.objects.countries.geometries)
                                ? worldData.objects.countries.geometries.find(g => g.id === d.id)
                                : null;
                            const props = (d && d.properties) ? d.properties : (geom && geom.properties) ? geom.properties : {};
                            const countryName = props.name || props.ADMIN || (geom && geom.properties && (geom.properties.name || geom.properties.ADMIN)) || 'Unknown';
                            
                            // Try to get ISO code from multiple sources
                            let isoCode = props.iso_a3 || props.ADM0_A3 || props.ISO_A3 || null;
                            
                            // Debug: log what we found
                            console.log(`Country: ${countryName}, ISO from props: ${isoCode}, in scores: ${isoCode && window.countryScores && window.countryScores[isoCode] ? 'YES' : 'NO'}`);
                            
                            // If ISO code not in our scores, try to resolve from country name
                            if ((!isoCode || !window.countryScores || window.countryScores[isoCode] === undefined) && countryName && countryName !== 'Unknown') {
                                try {
                                    const restResp = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(countryName)}?fields=cca3`);
                                    if (restResp.ok) {
                                        const restData = await restResp.json();
                                        if (Array.isArray(restData) && restData.length > 0) {
                                            const resolvedIso = restData[0].cca3;
                                            // Only use the resolved ISO if it's in our scores
                                            if (window.countryScores && window.countryScores[resolvedIso] !== undefined) {
                                                isoCode = resolvedIso;
                                                console.log(`Resolved ${countryName} to ${isoCode}`);
                                            }
                                        }
                                    }
                                } catch (e) {
                                    // Silent fail - we'll just use whatever isoCode we have
                                }
                            }
                            // Ensure per-country metrics are loaded from backend for this ISO (gdp/inflation/employment)
                            if (isoCode) {
                                try { await ensureMetricsForIso(isoCode); } catch (_) { /* ignore */ }
                            }
                            
                            // Try to get the score using various methods
                            let score = null;
                            if (isoCode && window.countryScores && window.countryScores[isoCode] !== undefined) {
                                score = window.countryScores[isoCode];
                            } else if (countryName && window.countryScores && window.countryScores[countryName] !== undefined) {
                                score = window.countryScores[countryName];
                            }

                            const placeholderInt = deterministicPlaceholder(d.id);
                            const displayScore = (score !== null) ? score : placeholderInt;
                            const pct = Math.max(0, Math.min(100, Math.round(displayScore)));

                            d3.select(this)
                                .style('opacity', 1)
                                .style('stroke-width', 2)
                                .style('cursor', 'pointer')
                                .style('fill', score !== null ? colorScale(score) : '#ccc')
                                .style('transform', 'scale(1.03)')
                                .raise();

                            const placeholderDecimal = (() => {
                                if (!d.id) return null;
                                let h = 0; for (let i = 0; i < d.id.length; i++) h = (h << 5) - h + d.id.charCodeAt(i);
                                h = Math.abs(h);
                                const v = (h % 10000) / 10000;
                                return v.toFixed(4);
                            })();

                            const decimalLabel = placeholderDecimal !== null ? `${(parseFloat(placeholderDecimal) * 100).toFixed(2)}%` : '';
                            const isPlaceholder = (score === null);
                            const rawToShow = isPlaceholder ? placeholderInt : score;

                            // Get metric data from static sources only (no API calls)
                            let metricValue = 'N/A';
                            let metricLabel = getMetricLabel();
                            
                            if (currentMetric === 'economic') {
                                metricValue = score !== null ? score.toFixed(1) : 'N/A';
                            } else if (currentMetric === 'gdp') {
                                metricValue = window.countryMetrics && window.countryMetrics.gdp && window.countryMetrics.gdp[isoCode] 
                                    ? window.countryMetrics.gdp[isoCode].toFixed(2) 
                                    : 'N/A';
                            } else if (currentMetric === 'inflation') {
                                metricValue = window.countryMetrics && window.countryMetrics.inflation && window.countryMetrics.inflation[isoCode] 
                                    ? window.countryMetrics.inflation[isoCode].toFixed(2) 
                                    : 'N/A';
                            } else if (currentMetric === 'employment') {
                                metricValue = window.countryMetrics && window.countryMetrics.employment && window.countryMetrics.employment[isoCode] 
                                    ? window.countryMetrics.employment[isoCode].toFixed(2) 
                                    : 'N/A';
                            }
                            
                            // Get color value based on metric
                            let colorValue;
                            const displayValue = typeof metricValue === 'number' ? metricValue : parseFloat(metricValue);
                            
                            if (currentMetric === 'economic') {
                                colorValue = displayValue;
                            } else if (currentMetric === 'gdp') {
                                colorValue = (displayValue + 5) * 10; // Scale -5% to +5% to 0-100
                            } else if (currentMetric === 'inflation') {
                                colorValue = Math.max(0, 100 - displayValue * 5); // Lower inflation is better
                            } else if (currentMetric === 'employment') {
                                colorValue = Math.max(0, 100 - displayValue * 5); // Lower unemployment is better
                            }

                            // Determine status based on current metric and live data
                            let statusText = 'Unknown';
                            if (!isNaN(displayValue)) {
                                if (currentMetric === 'economic') {
                                    statusText = displayValue >= 70 ? 'Excellent' :
                                               displayValue >= 50 ? 'Good' :
                                               displayValue >= 30 ? 'Fair' : 'Poor';
                                } else if (currentMetric === 'gdp') {
                                    statusText = displayValue >= 3 ? 'Strong Growth' :
                                               displayValue >= 1 ? 'Moderate Growth' :
                                               displayValue >= 0 ? 'Slow Growth' : 'Contraction';
                                } else if (currentMetric === 'inflation') {
                                    statusText = displayValue <= 2 ? 'Stable' :
                                               displayValue <= 5 ? 'Moderate' :
                                               displayValue <= 10 ? 'High' : 'Very High';
                                } else if (currentMetric === 'employment') {
                                    statusText = displayValue <= 4 ? 'Low' :
                                               displayValue <= 7 ? 'Moderate' :
                                               displayValue <= 10 ? 'High' : 'Very High';
                                }
                            }

                            const tooltipHtml = `
                                <div style="min-width:240px; background: rgba(15, 23, 42, 0.95); padding: 12px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                    <div style="font-weight:700; margin-bottom:6px; color:#fff;">${countryName}</div>
                                    <div style="display:flex; justify-content:space-between; align-items:baseline; gap:12px; margin-bottom:8px;">
                                        <div style="font-size:12px; color:#94a3b8">${metricLabel}:</div>
                                        <div style="font-size:20px; font-weight:800; color:${colorScale(colorValue)}">${metricValue}${currentMetric !== 'economic' ? '%' : ''}</div>
                                    </div>
                                    <div style="height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; margin:8px 0;">
                                        <div style="height:100%; width:${Math.min(100, Math.max(0, colorValue))}%; background:${colorScale(colorValue)}; transition:width 0.3s ease;"></div>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-top:8px;">
                                        <span style="color:#94a3b8; font-size:12px;">Status:</span>
                                        <span style="color:${colorScale(colorValue)}; font-weight:500; font-size:12px;">
                                            ${statusText}
                                        </span>
                                    </div>
                                    ${currentMetric === 'economic' ? `
                                        <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">
                                            <div style="font-size:11px; color:#94a3b8;">Economic Score</div>
                                            <div style="font-size:12px; color:#22c55e; font-weight:600;">${typeof score === 'number' ? score.toFixed(1) : 'N/A'}/100</div>
                                        </div>
                                    ` : ''}
                                    <div style="color:#64748b; font-size:11px; margin-top:8px;">
                                        ISO Code: ${isoCode || 'Unknown'} | Live Data
                                    </div>
                                </div>
                            `;

                            tooltipDiv.html(tooltipHtml)
                                .style('left', (event.pageX + 12) + 'px')
                                .style('top', (event.pageY - 34) + 'px')
                                .style('opacity', 1)
                                .style('transform', 'translateY(0px)')
                                .style('display', 'block')
                                .style('pointer-events', 'none');
                        })
                        .on('mouseout', function(event, d) {
                            const country = worldData.objects.countries.geometries.find(g => g.id === d.id);
                            const isoCode = country ? country.properties.iso_a3 : null;
                            const rawScore = isoCode && window.countryScores ? window.countryScores[isoCode] : undefined;
                            const originalScore = (typeof rawScore === 'number') ? rawScore : null;

                            const originalFill = originalScore !== null ? colorScale(Math.max(0, Math.min(100, Math.round(originalScore)))) : '#ccc';

                            d3.select(this)
                                .style('opacity', 0.8)
                                .style('stroke-width', 0.5)
                                .style('transform', 'scale(1)')
                                .style('fill', originalFill);

                            tooltipDiv.style('opacity', 0).style('display', 'none');
                        })
                        .on('click', function(event, d) {
                            const country = worldData.objects.countries.geometries.find(g => g.id === d.id);
                            const isoCode = country ? country.properties.iso_a3 : null;
                            if (isoCode && globalScores[isoCode] !== undefined) {
                                const score = globalScores[isoCode];
                                const detailsDiv = document.createElement('div');
                                detailsDiv.style.cssText = `
                                    position: fixed;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    background: white;
                                    padding: 20px;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                                    z-index: 10000;
                                    max-width: 400px;
                                    width: 90%;
                                `;
                                detailsDiv.innerHTML = `
                                    <h2 style="font-size: 24px; margin-bottom: 16px; color: #1e293b;">${country.properties.name}</h2>
                                    <div style="font-size: 48px; font-weight: bold; color: ${colorScale(score)}; margin-bottom: 20px;">
                                        ${score.toFixed(1)}
                                    </div>
                                    <div style="margin-bottom: 16px;">
                                        <div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Economic Score Range</div>
                                        <div style="height: 8px; background: #e2e8f0; border-radius: 4px; position: relative;">
                                            <div style="position: absolute; height: 100%; width: ${score}%; background: ${colorScale(score)}; border-radius: 4px;"></div>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-top: 4px; color: #94a3b8; font-size: 12px;">
                                            <span>0</span>
                                            <span>50</span>
                                            <span>100</span>
                                        </div>
                                    </div>
                                    <button onclick="this.parentElement.remove()" style="position: absolute; top: 12px; right: 12px; background: none; border: none; cursor: pointer; color: #64748b;">&times;</button>
                                `;
                                document.body.appendChild(detailsDiv);
                            }
                        });

                    // Legend
                    const legend = svg.append('g')
                        .attr('class', 'legend')
                        .attr('transform', `translate(${width - 220}, ${height - 80})`);

                    const defs = svg.append('defs');
                    const gradient = defs.append('linearGradient')
                        .attr('id', 'gradient')
                        .attr('x1', '0%')
                        .attr('y1', '0%')
                        .attr('x2', '100%')
                        .attr('y2', '0%');

                    gradient.append('stop')
                        .attr('offset', '0%')
                        .attr('stop-color', '#ef4444');

                    gradient.append('stop')
                        .attr('offset', '25%')
                        .attr('stop-color', '#ff8a00');

                    gradient.append('stop')
                        .attr('offset', '50%')
                        .attr('stop-color', '#fef3c7');

                    gradient.append('stop')
                        .attr('offset', '75%')
                        .attr('stop-color', '#84cc16');

                    gradient.append('stop')
                        .attr('offset', '100%')
                        .attr('stop-color', '#22c55e');

                    legend.append('rect')
                        .attr('width', 200)
                        .attr('height', 20)
                        .style('fill', 'url(#gradient)');

                    legend.append('text')
                        .attr('x',  0)
                        .attr('y', 40)
                        .text('1 (Low)')
                        .style('font-size', '12px');

                    legend.append('text')
                        .attr('x', 100)
                        .attr('y', 40)
                        .text('50')
                        .style('font-size', '12px')
                        .style('text-anchor', 'middle');

                    legend.append('text')
                        .attr('x', 200)
                        .attr('y', 40)
                        .text('100 (High)')
                        .style('font-size', '12px')
                        .style('text-anchor', 'end');
                });
            };

            // run on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // redraw on resize
            let rt;
            window.addEventListener('resize', () => {
                clearTimeout(rt);
                rt = setTimeout(() => {
                    init();
                }, 250);
           
            });
        })();

        // Map controls
        const mapBtns = document.querySelectorAll('.map-btn');
        mapBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                mapBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        
        // Time selector
        const timeBtns = document.querySelectorAll('.time-btn');
        timeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                timeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        
        // Product card interactions
        const productCards = document.querySelectorAll('.product-card');
        productCards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-8px)';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
            });
        });

        async function resolveIsoByName(name) {
            try {
                const resp = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}?fields=cca3`);
                if (resp.ok) {
                    const data = await resp.json();
                    if (Array.isArray(data) && data.length > 0) {
                        console.log(`Resolved ISO3 for ${name}: ${data[0].cca3}`); // Debug log
                        return data[0].cca3; // Return ISO3 code
                    }
                }
            } catch (err) {
                console.warn(`Failed to resolve ISO3 for country name: ${name}`, err);
            }
            return null; // Fallback to null if resolution fails
        }

        async function enhanceCountryScoresWithIso() {
            const features = await d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
                .then(worldData => topojson.feature(worldData, worldData.objects.countries).features);

            for (const feature of features) {
                const name = feature.properties.name || feature.properties.ADMIN;
                const isoCode = feature.properties.iso_a3 || feature.properties.ADM0_A3;

                if (!isoCode && name) {
                    const resolvedIso = await resolveIsoByName(name);
                    if (resolvedIso) {
                        console.log(`Mapping score for ${name} (${resolvedIso})`); // Debug log
                        window.countryScores[resolvedIso] = window.countryScores[name];
                    }
                }
            }

            console.log('Enhanced country scores:', window.countryScores); // Debug log
        }

        // Initialize country scores with fallback static data (will be overridden by backend if available)
        const fallbackScores = {"THA":50,"DJI":27,"LTU":48,"TLS":48,"MRT":40,"POL":49,"CSS":45,"NAC":62,"MNG":43,"MAC":55,"NZL":56,"TUN":36,"EAR":45,"MDV":48,"KNA":34,"CIV":47,"IND":45,"IDA":45,"BOL":47,"TEC":45,"GUM":43,"BRA":42,"HND":41,"JAM":46,"MEX":48,"OMN":51,"LCN":45,"BIH":39,"ITA":49,"GUY":42,"NAM":33,"EGY":42,"SRB":43,"LCA":38,"SST":45,"ZMB":43,"LSO":34,"MCO":100,"MNP":10,"COD":33,"LBY":34,"ASM":8,"WLD":47,"BGR":47,"LMY":45,"EST":49,"HRV":46,"IDX":44,"COL":41,"CRI":42,"NIC":44,"LKA":41,"HUN":49,"TCD":48,"GAB":33,"GNB":46,"CYM":41,"ISL":62,"PLW":30,"KHM":49,"LVA":46,"MHL":3,"ROU":46,"QAT":68,"IMN":39,"SYR":37,"STP":40,"CZE":52,"AFG":36,"PRE":44,"CUW":33,"BGD":45,"NRU":6,"DMA":30,"TSS":43,"SYC":32,"AFE":42,"LIE":83,"CHE":66,"GNQ":43,"SLE":44,"UZB":45,"NCL":35,"ZAF":22,"KGZ":45,"SSF":43,"EAP":47,"CAF":44,"ISR":58,"TMN":41,"CYP":50,"GBR":55,"ERI":84,"COM":34,"ECU":47,"FRA":52,"LDC":44,"BHS":49,"ECS":49,"MEA":43,"MIC":45,"MOZ":45,"BLR":46,"COG":32,"GEO":40,"HKG":56,"CPV":39,"LUX":72,"FSM":28,"PRT":49,"PST":56,"TTO":50,"ECA":43,"MDA":47,"ARG":38,"ARM":38,"TUV":3,"UKR":40,"MNA":41,"ABW":36,"TJK":25,"BRB":47,"LBR":46,"AGO":35,"KWT":56,"SUR":38,"LAC":45,"MUS":45,"KOR":53,"DZA":39,"ARE":57,"LAO":46,"MLI":46,"RWA":35,"GMB":43,"CHL":44,"MAR":41,"BTN":44,"OSS":44,"SGP":66,"LTE":47,"TSA":45,"CHI":50,"DNK":60,"SVK":47,"RUS":49,"PAN":46,"MKD":37,"PSS":47,"ESP":44,"DEU":57,"FCS":44,"MLT":54,"AUT":56,"NLD":58,"JPN":54,"SXM":16,"CUB":38,"EMU":52,"ALB":41,"MYS":48,"NGA":44,"PYF":31,"EUU":51,"PSE":29,"HTI":33,"LBN":21,"DOM":46,"ARB":42,"PNG":47,"ZWE":29,"MDG":46,"AFW":46,"SWE":54,"SMR":44,"BFA":44,"MMR":46,"HPC":45,"KIR":27,"MWI":43,"AZE":45,"TKM":35,"VEN":84,"IDN":47,"SAS":45,"SLV":47,"NER":49,"FIN":54,"GRC":42,"MNE":37,"SLB":48,"TZA":47,"BMU":54,"IRL":68,"YEM":51,"WSM":45,"IRQ":37,"PRY":44,"BEL":55,"TEA":47,"TGO":47,"GRD":30,"BLZ":43,"SSD":79,"BHR":55,"IDB":45,"PRK":92,"VUT":45,"IBT":45,"SSA":43,"FRO":29,"IBD":45,"BDI":46,"TCA":14,"PAK":43,"GTM":47,"VCT":34,"JOR":34,"NPL":40,"SAU":53,"PER":47,"PRI":41,"VNM":49,"SDN":28,"SOM":17,"TLA":45};
        
        // Set fallback scores initially
        window.countryScores = fallbackScores;
        
        // Create a map for alternative country codes
        const alternativeCodes = {
            'USA': 'United States',
            'GBR': 'United Kingdom',
            'RUS': 'Russian Federation',
            // Add more mappings as needed
        };
        
        // Add alternative codes to countryScores
        Object.entries(alternativeCodes).forEach(([code, altName]) => {
            if (fallbackScores[code] !== undefined && !window.countryScores[altName]) {
                window.countryScores[altName] = fallbackScores[code];
            }
        });

        // Enhance scores before map initialization
        // Ensure per-country metrics (gdp/inflation/employment) are available from backend
        async function ensureMetricsForIso(iso3) {
            if (!iso3) return;
            window.countryMetrics = window.countryMetrics || { gdp: {}, inflation: {}, employment: {} };
            if (Object.prototype.hasOwnProperty.call(window.countryMetrics.gdp, iso3) ||
                Object.prototype.hasOwnProperty.call(window.countryMetrics.inflation, iso3) ||
                Object.prototype.hasOwnProperty.call(window.countryMetrics.employment, iso3)) {
                return;
            }
            try {
                const r = await fetch(`/api/v1/country-metrics/${iso3}/`);
                if (!r.ok) throw new Error(`status=${r.status}`);
                const metrics = await r.json();
                window.countryMetrics.gdp[iso3] = metrics.gdp !== undefined && metrics.gdp !== null ? parseFloat(metrics.gdp) : null;
                window.countryMetrics.inflation[iso3] = metrics.inflation !== undefined && metrics.inflation !== null ? parseFloat(metrics.inflation) : null;
                window.countryMetrics.employment[iso3] = metrics.employment !== undefined && metrics.employment !== null ? parseFloat(metrics.employment) : null;
                console.info(`Loaded metrics for ${iso3}`, metrics);
            } catch (err) {
                console.warn(`Failed to load metrics for ${iso3}`, err);
                window.countryMetrics.gdp[iso3] = window.countryMetrics.gdp[iso3] ?? null;
                window.countryMetrics.inflation[iso3] = window.countryMetrics.inflation[iso3] ?? null;
                window.countryMetrics.employment[iso3] = window.countryMetrics.employment[iso3] ?? null;
            }
        }

        async function prefetchMetricsForList(isoList, opts = {}) {
            const batchSize = opts.batchSize || 8;
            const delayMs = opts.delayMs || 250;
            for (let i = 0; i < isoList.length; i += batchSize) {
                const batch = isoList.slice(i, i + batchSize);
                await Promise.all(batch.map(iso => ensureMetricsForIso(iso)));
                await new Promise(res => setTimeout(res, delayMs));
            }
        }

        // Load country scores from backend, then enhance and initialize map
        async function loadCountryScores() {
            try {
                const resp = await fetch('/api/v1/country-scores/');
                if (!resp.ok) throw new Error(`status=${resp.status}`);
                const scores = await resp.json();
                if (scores && typeof scores === 'object') {
                    window.countryScores = scores;
                    window.countryMetrics = window.countryMetrics || { economic: {}, gdp: {}, inflation: {}, employment: {} };
                    window.countryMetrics.economic = window.countryScores;
                    console.info('Loaded country-scores from backend:', Object.keys(window.countryScores).length);
                }
            } catch (e) {
                console.warn('Could not load /api/v1/country-scores/, using fallback', e);
                window.countryScores = window.countryScores || fallbackScores;
            }


            try {
                const prefetchCount = 40;
                const isoList = Object.keys(window.countryScores || {}).sort((a, b) => (window.countryScores[b] || 0) - (window.countryScores[a] || 0)).slice(0, prefetchCount);
                if (isoList.length) {
                    console.info(`Prefetching metrics for top ${isoList.length} countries`);
                    await prefetchMetricsForList(isoList, { batchSize: 8, delayMs: 200 });
                }
            } catch (pfErr) {
                console.warn('Prefetch metrics failed', pfErr);
            }

            // Additionally, fetch GDP per-capita for all countries in one bulk request
            try {
                const gdpResp = await fetch('/api/v1/gdp-per-capita/');
                if (gdpResp.ok) {
                    const gdpMap = await gdpResp.json();
                    window.countryMetrics = window.countryMetrics || { gdp: {}, inflation: {}, employment: {}, economic: {} };
                    // copy values into window.countryMetrics.gdp
                    Object.keys(gdpMap).forEach(k => {
                        const v = gdpMap[k];
                        window.countryMetrics.gdp[k] = (v === null || v === undefined) ? null : parseFloat(v);
                    });
                    console.info('Loaded GDP per-capita map for', Object.keys(window.countryMetrics.gdp).length, 'countries');
                } else {
                    console.warn('Failed to load /api/v1/gdp-per-capita/', gdpResp.status);
                }
            } catch (e) {
                console.warn('Error fetching gdp-per-capita mapping:', e);
            }

            // Once loaded (or fallback applied), enhance mapping and trigger map update
            await enhanceCountryScoresWithIso();
            console.info('Enhanced country scores with ISO3 codes');
            window.dispatchEvent(new Event('resize'));
        }

        // Start loading live scores and metrics
        loadCountryScores();

        // If backend isn't running or you prefer direct World Bank data, fetch GDP indicators client-side
        // This populates window.countryMetrics.gdpPerCapita (USD) and window.countryMetrics.gdpGrowth (% annual)
        async function fetchWorldBankIndicatorAll(indicator) {
            const perPage = 30000;
            const url = `https://api.worldbank.org/v2/country/all/indicator/${indicator}?format=json&per_page=${perPage}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`WB ${indicator} status=${resp.status}`);
                const data = await resp.json();
                if (!Array.isArray(data) || data.length < 2) return {};
                const rows = data[1];
                const map = {}; // iso3 -> {year, value}
                for (const r of rows) {
                    const iso = r.countryiso3code || (r.country && r.country.id) || null;
                    const year = r.date ? parseInt(r.date, 10) : null;
                    const val = r.value !== null ? Number(r.value) : null;
                    if (!iso) continue;
                    if (val === null) continue;
                    if (!map[iso] || (year !== null && map[iso].year !== null && year > map[iso].year) || (map[iso].year === null && year !== null)) {
                        map[iso] = { year, value: val };
                    }
                }
                const out = {};
                for (const iso of Object.keys(map)) out[iso] = map[iso].value;
                return out;
            } catch (e) {
                console.warn('Failed to fetch World Bank indicator', indicator, e);
                return {};
            }
        }

        (async () => {
            window.countryMetrics = window.countryMetrics || {};
            // Fetch GDP per-capita (USD)
            const perCapita = await fetchWorldBankIndicatorAll('NY.GDP.PCAP.CD');
            window.countryMetrics.gdpPerCapita = Object.assign({}, window.countryMetrics.gdpPerCapita || {}, perCapita);
            // Fetch GDP growth (annual %)
            const growth = await fetchWorldBankIndicatorAll('NY.GDP.MKTP.KD.ZG');
            window.countryMetrics.gdpGrowth = Object.assign({}, window.countryMetrics.gdpGrowth || {}, growth);
            console.info('World Bank: loaded GDP per-capita and growth for', Object.keys(window.countryMetrics.gdpPerCapita).length, 'countries');
        })();
    </script>
    <script type="module" src="scripts/site-init.js"></script>
    <script src="scripts/auth-handler.js"></script>
</body>
</html>